name: Build WinPython for 2025-05 Cycle
# matrix allows to avoid duplicated code in github_workflows_build-dot, github_workflows_build-whl, github_workflows_build-slim
# 2025-08-23a: merged code proposed per Gemini 2.5 flash, it corrected also PYTHONIOENCODING="utf-8" error
# 2025-08-23b: moved manually to Python-3.14.0rc2
# 2025-08-25a: will use manual uploaded free-threading, as astral doesn't provide
# 2025-08-25b: move up all parameters  
# 2025-09-07: one single workflow to reduce code duplication 
# 2025-11-30: centralize links in one place, add 3.15, classify as b4
# 2025-11-30: reduce repetition of parameters

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to build (3.13, 3.14 or 3.15)'
        required: true
        default: '3.14'
        type: choice
        options:
          - '3.13'
          - '3.14'
          - '3.15'

jobs:
  build-winpython:
    runs-on: windows-latest

    strategy:
      fail-fast: true
      matrix:
        flavor:
          - name: "dot"
            REQUIREMENTS_313: "winpython\\portable\\cycle_2025_05\\requir.64-3_13_8_0dotb4.txt"
            REQUIREMENTS_314: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2dotb4.txt"
            REQUIREMENTS_315: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2dotb4.txt"
            REQUIREMENTS_WHL_313: ""
            REQUIREMENTS_WHL_314: ""
            REQUIREMENTS_WHL_315: ""
            ZIP: "1"
            SEVEN_Z: "0"
            EXE: "1"
            PANDOC: "0"
            WINPYARCH: "64"
            WINPYARCHDET: "64"
            my_release_level: "b4"
          - name: "slim"
            REQUIREMENTS_313: "winpython\\portable\\cycle_2025_05\\requir.64-3_13_8_0slimb4.txt"
            REQUIREMENTS_314: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2slimb4.txt"
            REQUIREMENTS_315: ""
            REQUIREMENTS_WHL_313: ""
            REQUIREMENTS_WHL_314: ""
            REQUIREMENTS_WHL_315: ""
            ZIP: "0"
            SEVEN_Z: "1"
            EXE: "1"
            PANDOC: "1"
            WINPYARCH: "64"
            WINPYARCHDET: "64"
            my_release_level: "b4"
          - name: "whl"
            REQUIREMENTS_313: "winpython\\portable\\cycle_2025_05\\requir.64-3_13_8_0dotb4.txt"
            REQUIREMENTS_314: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2dotb4.txt"
            REQUIREMENTS_315: ""
            REQUIREMENTS_WHL_313: "winpython\\portable\\cycle_2025_05\\requir.64-3_13_8_0whlb3_wheels.txt"
            REQUIREMENTS_WHL_314: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2whlb3_wheels.txt"
            REQUIREMENTS_WHL_315: ""
            ZIP: "0"
            SEVEN_Z: "1"
            EXE: "0"
            PANDOC: "0"
            WINPYARCH: "64"
            WINPYARCHDET: "64"
            my_release_level: "b4"
          - name: "free"
            REQUIREMENTS_313: ""
            REQUIREMENTS_314: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2freeb4.txt"
            REQUIREMENTS_315: ""
            REQUIREMENTS_WHL_313: ""
            REQUIREMENTS_WHL_314: ""
            REQUIREMENTS_WHL_315: ""
            ZIP: "1"
            SEVEN_Z: "0"
            EXE: "1"
            PANDOC: "0"
            WINPYARCH: "64"
            WINPYARCHDET: "64F"
            my_release_level: "b4"
          - name: "slimf"
            REQUIREMENTS_313: ""
            REQUIREMENTS_314: "winpython\\portable\\cycle_2025_05\\requir.64-3_14_0_2slimfb4.txt"
            REQUIREMENTS_315: ""
            REQUIREMENTS_WHL_313: ""
            REQUIREMENTS_WHL_314: ""
            REQUIREMENTS_WHL_315: ""
            ZIP: "1"
            SEVEN_Z: "0"
            EXE: "1"
            PANDOC: "0"
            WINPYARCH: "64"
            WINPYARCHDET: "64F"
            my_release_level: "b4"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set static and matrix variables based on selected Python version
        shell: bash
        run: |
          PYTHON_VERSION="${{ github.event.inputs.python_version }}"
          FLAVOR="${{ matrix.flavor.name }}"
          WINPYARCH="${{ matrix.flavor.WINPYARCH }}"
          WINPYARCHDET="${{ matrix.flavor.WINPYARCHDET }}"

          # Populate generic per-flavor / per-version selections
          if [ "$PYTHON_VERSION" = "3.13" ]; then
            echo "WINPYREQUIREMENTS=${{ matrix.flavor.REQUIREMENTS_313 }}" >> $GITHUB_ENV
            echo "WINPYREQUIREMENTSwhl=${{ matrix.flavor.REQUIREMENTS_WHL_313 }}" >> $GITHUB_ENV
            echo "WINPYVERSION=313" >> $GITHUB_ENV
            WINPYVER2="3.13.8.0"
            BUILD_LOCATION="WPy64-31380"
          elif [ "$PYTHON_VERSION" = "3.14" ]; then
            echo "WINPYREQUIREMENTS=${{ matrix.flavor.REQUIREMENTS_314 }}" >> $GITHUB_ENV
            echo "WINPYREQUIREMENTSwhl=${{ matrix.flavor.REQUIREMENTS_WHL_314 }}" >> $GITHUB_ENV
            echo "WINPYVERSION=314" >> $GITHUB_ENV
            WINPYVER2="3.14.0.2"
            BUILD_LOCATION="WPy64-31380"
          elif [ "$PYTHON_VERSION" = "3.15" ]; then
            echo "WINPYREQUIREMENTS=${{ matrix.flavor.REQUIREMENTS_315 }}" >> $GITHUB_ENV
            echo "WINPYREQUIREMENTSwhl=${{ matrix.flavor.REQUIREMENTS_WHL_315 }}" >> $GITHUB_ENV
            echo "WINPYVERSION=315" >> $GITHUB_ENV
            WINPYVER2="3.15.0.0"
            BUILD_LOCATION="WPy64-31500"
          fi

          # write common flavor env vars
          echo "WINPYVER2=$WINPYVER2" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=publish_${PYTHON_VERSION}${FLAVOR}" >> $GITHUB_ENV
          echo "build_location=$BUILD_LOCATION" >> $GITHUB_ENV
          echo "destwheelhouse=${BUILD_LOCATION}\\wheelhouse\\included.wheels" >> $GITHUB_ENV
          echo "WINPYVER=${WINPYVER2}${{ matrix.flavor.name }}${{ matrix.flavor.my_release_level }}" >> $GITHUB_ENV
 
          echo "WINPYARCH=$WINPYARCH" >> $GITHUB_ENV
          echo "WINPYARCHDET=$WINPYARCHDET" >> $GITHUB_ENV
          echo "WINPYFLAVOR=$FLAVOR" >> $GITHUB_ENV
          echo "WINPYZIP=${{ matrix.flavor.ZIP }}" >> $GITHUB_ENV
          echo "WINPY7Z=${{ matrix.flavor.SEVEN_Z }}" >> $GITHUB_ENV
          echo "WINPYEXE=${{ matrix.flavor.EXE }}" >> $GITHUB_ENV
          echo "PANDOC=${{ matrix.flavor.PANDOC }}" >> $GITHUB_ENV
          echo "my_release_level=${{ matrix.flavor.my_release_level }}" >> $GITHUB_ENV

          # constants
          echo "dotwheelhouse=dotpython\\wheelhouse\\included.wheels" >> $GITHUB_ENV
          echo "pandoc_source=https://github.com/jgm/pandoc/releases/download/3.1.9/pandoc-3.1.9-windows-x86_64.zip" >> $GITHUB_ENV
          echo "pandoc_sha256=11eb6dbe5286c9e5edb0cca4412e7d99ec6578ec04158b0b7fe11f7fd96688e5"  >> $GITHUB_ENV

          # Centralized mapping of python binaries and SHAs by version and arch.
          # NOTE: fill the 3.15 URLs and SHA values when available.
          # 3.13 x64 (GIL)
          if [ "$PYTHON_VERSION" = "3.13" ] && [ "$WINPYARCHDET" = "64" ]; then
            echo "python_source=https://github.com/astral-sh/python-build-standalone/releases/download/20251031/cpython-3.13.9+20251031-x86_64-pc-windows-msvc-install_only_stripped.tar.gz" >> $GITHUB_ENV
            echo "python_sha256=3cdf2ad27fdeea2592b63e5a658aa65733b028a55332fa1aa27be4ce8aef96c0" >> $GITHUB_ENV
          fi

          # 3.14 x64 (GIL)
          if [ "$PYTHON_VERSION" = "3.14" ] && [ "$WINPYARCHDET" = "64" ]; then
            echo "python_source=https://github.com/astral-sh/python-build-standalone/releases/download/20251031/cpython-3.14.0+20251031-x86_64-pc-windows-msvc-install_only_stripped.tar.gz" >> $GITHUB_ENV
            echo "python_sha256=a64800cbfbf1c384b9ac7eb5964a9a4c37537791e7ac80eb66b03ccb6f2c2e80" >> $GITHUB_ENV
          fi

          # 3.14 X64 (free-threading)
          # SHA not provided here: fill the correct SHA for security, otherwise the workflow will skip SHA check.
          if [ "$PYTHON_VERSION" = "3.14" ] && [ "$WINPYARCHDET" = "64F" ]; then
            echo "python_source=https://github.com/astral-sh/python-build-standalone/releases/download/20251031/cpython-3.14.0+20251031-x86_64-pc-windows-msvc-freethreaded+pgo-full.tar.zst" >> $GITHUB_ENV
            echo "python_sha256=b81de5fc9e783ea6dfcf1098c28a278c874999c71afbb0309f6a8b4276c769d0"
          fi

          # 3.15 X64 (GIL)
          if [ "$PYTHON_VERSION" = "3.15" ] && [ "$WINPYARCHDET" = "64" ]; then
            # Example placeholders -- replace with real URLs and shas when available
            echo "python_source=https://github.com/astral-sh/python-build-standalone/releases/download/20251120/cpython-3.15.0a2+20251120-x86_64-pc-windows-msvc-install_only_stripped.tar.gz" >> $GITHUB_ENV
            echo "python_sha256=50e8d463a7838c36e01b053a8d01d5c58519e530098d52c7456660a76f3f35f7" >> $GITHUB_ENV
          fi

      - name: See variables
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          Write-Output "PYTHON_VERSION is $env:PYTHON_VERSION" 
          Write-Output "WINPYFLAVOR is $env:WINPYFLAVOR"  

          Write-Output "WINPYREQUIREMENTS is $env:WINPYREQUIREMENTS"
          Write-Output "WINPYREQUIREMENTSwhl is $env:WINPYREQUIREMENTSwhl"
          Write-Output "ARTIFACT_NAME is $env:ARTIFACT_NAME"  

          Write-Output "python_source is $env:python_source"
          Write-Output "python_sha256 is $env:python_sha256"

          Write-Output "WINPYVERSION is $env:WINPYVERSION" 
          Write-Output "WINPYVER2 is $env:WINPYVER2"
          Write-Output "build_location is $env:build_location"

          Write-Output "WINPYARCH is $env:WINPYARCH"
          Write-Output "WINPYARCHDET is $env:WINPYARCHDET"
          Write-Output "WINPYZIP is $env:WINPYZIP"
          Write-Output "WINPY7Z is $env:WINPY7Z"
          Write-Output "WINPYEXE is $env:WINPYEXE"
          Write-Output "PANDOC is $env:PANDOC"
          Write-Output "dotwheelhouse is $env:dotwheelhouse"
          Write-Output "destwheelhouse is $env:destwheelhouse"

          Write-Output "pandoc_source is $env:pandoc_source" 
          Write-Output "pandoc_sha256 is $env:pandoc_sha256"  

          Write-Output "WINPYVER is $env:WINPYVER"

      - name: Download python-3 standalone
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          Write-Output "python_source used is $env:python_source"
          curl.exe -L -o "python-3-embed.tar.gz" $env:python_source
          # Calculate SHA256 hash
          $filePath = "python-3-embed.tar.gz"
          $expectedHash = $env:python_sha256

          $hashObject = Get-FileHash -Path $filePath -Algorithm SHA256
          $actualHash = $hashObject.Hash.ToLower()

          if ($actualHash -eq $expectedHash.ToLower()) {
              Write-Output "Hash matches."
          } else {
              Write-Output "Hash does NOT match."
              Write-Output "Actual: $actualHash"
              Write-Output "Expected: $expectedHash"
              exit 1
          }

      - name: Extract python-3-embed.tar.gz to dotpython
        if: env.WINPYREQUIREMENTS != ''
        shell: bash
        run: |
          mkdir -p dotpythonpre
          mkdir -p dotpython
          mkdir -p dotpython/python
          tar -xf python-3-embed.tar.gz -C dotpythonpre
          if [ -d dotpythonpre/python/install ]; then
              mv dotpythonpre/python/install/* dotpython/python/
          elif [ -d dotpythonpre/python ]; then
              mv dotpythonpre/python/* dotpython/python/
          fi
    
      - name: Copy launchers_final files to dotpython
        if: env.WINPYREQUIREMENTS != ''
        shell: bash
        run: |
          cp -r winpython/portable/launchers_final/* dotpython/
          mkdir $env:dotwheelhouse

      - name: List dotpython contents (for debugging)
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          Get-ChildItem dotpython
          Get-ChildItem dotpython\python

      - name: Prepare WinPython target structure
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path $env:build_location
          Get-ChildItem -Path dotpython -Force | Move-Item -Destination $env:build_location -Force

      - name: Download and integrate pandoc binary
        if: env.WINPYREQUIREMENTS != '' && env.PANDOC == '1'
        shell: pwsh
        run: |
          $pandocZipPath = "pandoc.zip"
          $tempDir = "pandoc_temp"
          $targetDir = "$env:build_location\t"
          
          # Download the zip file
          Write-Host "Downloading Pandoc from $env:pandoc_source"
          curl.exe -L -o $pandocZipPath $env:pandoc_source
          
          # Create a temporary directory for extraction
          Write-Host "Creating temporary directory for extraction"
          mkdir -p $tempDir
          
          # Unzip the contents to the temporary directory
          Write-Host "Extracting archive to temporary directory"
          Expand-Archive -Path $pandocZipPath -DestinationPath $tempDir
          
          # Create the final target directory
          Write-Host "Creating final target directory: $targetDir"
          if (-not (Test-Path -Path $targetDir)) {
              mkdir -p $targetDir
          }
          
          # Find and copy only the pandoc.exe file
          Write-Host "Copying pandoc.exe to $targetDir"
          Copy-Item -Path (Join-Path $tempDir "pandoc-3.1.9\pandoc.exe") -Destination $targetDir -Force         

          # Optional: Verify the contents
          Write-Host "Listing contents of $targetDir"
          Get-ChildItem -Path $targetDir

          # Calculate SHA256 hash
          $filePath = $pandocZipPath
          $expectedHash = $env:pandoc_sha256

          $hashObject = Get-FileHash -Path $filePath -Algorithm SHA256
          $actualHash = $hashObject.Hash.ToLower()

          if ($actualHash -eq $expectedHash.ToLower()) {
              Write-Output "Hash matches."
          } else {
              Write-Output "Hash does NOT match."
              Write-Output "Actual: $actualHash"
              Write-Output "Expected: $expectedHash"
              exit 1
          }

          # Optional: Clean up temporary files
          Write-Host "Cleaning up temporary files..."
          Remove-Item -Path $tempDir -Recurse -Force
          Remove-Item -Path $pandocZipPath -Force
          

      - name: Upgrade pip and patch launchers
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          & "$env:build_location\python\python.exe" -m pip install --upgrade pip
          & "$env:build_location\python\python.exe" -m pip install --upgrade packaging==25.0
          & "$env:build_location\python\python.exe" -c "from wppm import wppm;dist=wppm.Distribution();dist.patch_standard_packages('pip', to_movable=True)"

      - name: Write env.ini file
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          $destDir = "$env:build_location\scripts"
          echo "WINPYthon_exe=$env:WINPYthon_exe" > env.ini
          echo "WINPYthon_subdirectory_name=$env:WINPYthon_subdirectory_name" >> env.ini
          echo "WINPYVER=$env:WINPYVER" >> env.ini
          echo "WINPYVER2=$env:WINPYVER2" >> env.ini
          echo "WINPYFLAVOR=$env:WINPYFLAVOR" >> env.ini
          echo "WINPYARCH=$env:WINPYARCH" >> env.ini
          Copy-Item -Path "env.ini" -Destination "$destDir\env.ini"

      - name: Download main requirements to $env:dotwheelhouse
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |

          & "$env:build_location\python\python.exe" -m pip download --dest $env:dotwheelhouse --no-deps --require-hashes -r $env:WINPYREQUIREMENTS

      - name: Download additional wheelhouse requirements
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          if ($env:WINPYREQUIREMENTSwhl -eq "") {
              Write-Output "No additional wheelhouse requirements."
          } else {
            & "$env:build_location\python\python.exe" -m pip download --dest $env:destwheelhouse --no-deps --require-hashes -r $env:WINPYREQUIREMENTSwhl
          }

      - name: Install requirements
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          & "$env:build_location\python\python.exe" -m pip install --no-deps --no-index --trusted-host=None --find-links=$env:dotwheelhouse --require-hashes -r $env:WINPYREQUIREMENTS

      - name: Generate Markdown content and pylock file
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          mkdir publish_output

          # Ensure unicode for wppm output
          $env:PYTHONIOENCODING="utf-8"

          $destfile_md = "publish_output\WinPython$env:WINPYFLAVOR-$($env:WINPYARCH)bit-$env:WINPYVER2.md" 
          & "$env:build_location\python\python.exe" -m wppm -md | Out-File -FilePath $destfile_md -Encoding utf8 

          gc $destfile_md

          & "$env:build_location\python\python.exe" -m pip freeze | Out-File -FilePath  dotpython\freeze.txt
          $destfile_pylock = "publish_output\pylock.$env:WINPYARCH-$($env:WINPYVER -replace '\.', '_').toml"
          & "$env:build_location\python\python.exe" -m pip lock --no-deps --find-links=$env:dotwheelhouse -r dotpython\freeze.txt -o $destfile_pylock

          $outreq = "publish_output\requir.$env:WINPYARCH-$($env:WINPYVER -replace '\.', '_').txt"
          & "$env:build_location\python\python.exe" -X utf8 -c "from wppm import wheelhouse as wh; wh.pylock_to_req(r'$destfile_pylock', r'$outreq')"

          if ($env:WINPYREQUIREMENTSwhl -eq "") {
              Write-Output "No additional wheelhouse requirements."
          } else {
          $destfile_pylockwheel = "publish_output\pylock.$env:WINPYARCH-$($env:WINPYVER -replace '\.', '_')_wheels.toml"
          & "$env:build_location\python\python.exe" -m pip lock --no-deps --require-hashes -r $env:WINPYREQUIREMENTSwhl -o $destfile_pylockwheel

          $outreqwheel = "publish_output\requir.$env:WINPYARCH-$($env:WINPYVER -replace '\.', '_')_wheels.txt"
          & "$env:build_location\python\python.exe" -X utf8 -c "from wppm import wheelhouse as wh; wh.pylock_to_req(r'$destfile_pylockwheel', r'$outreqwheel')"
          Copy-Item -Path $outreqwheel -Destination (Join-Path  $env:build_location "wheelhouse") -Force         
          Copy-Item -Path $destfile_pylockwheel -Destination (Join-Path  $env:build_location "wheelhouse") -Force         

          }

      - name: Zip the result
        if: env.WINPYREQUIREMENTS != '' && env.WINPYZIP == '1'
        shell: pwsh
        run: |
          $destfile = "publish_output\WinPython$env:WINPYARCH-$env:WINPYVER.zip" 
          Compress-Archive -Path "$env:build_location" -DestinationPath $destfile

      - name: 7z archive the result
        if: env.WINPYREQUIREMENTS != '' && env.WINPY7Z == '1'
        shell: pwsh
        run: |
          $destfile7z = "publish_output\WinPython$env:WINPYARCH-$env:WINPYVER.7z"
          $sourceDir = "$env:build_location"
          7z a $destfile7z $sourceDir

      - name: 7z executable archive the result
        if: env.WINPYREQUIREMENTS != '' && env.WINPYEXE == '1'
        shell: pwsh
        run: |
          $destfile7z = "publish_output\WinPython$env:WINPYARCH-$env:WINPYVER.exe"
          $sourceDir = "$env:build_location"

          # Define the standard 7-Zip installation path (adjust if using a custom install)
          $SevenZipDir = "C:\Program Files\7-Zip" 
          Get-ChildItem $SevenZipDir
          # Use the full path to the SFX module
          $SFXModulePath = "C:\Program Files\7-Zip\7z.sfx"
    
          #7z a -sfx $destfile7z $sourceDir
          #7z a -t7z -sfx7z.sfx $destfile7z $sourceDir
          7z a -t7z -sfx"$SFXModulePath" $destfile7z $sourceDir

      - name: generate hashes wppm style
        if: env.WINPYREQUIREMENTS != ''
        shell: pwsh
        run: |
          $DESTFILE="./publish_output/hashes.md" 
          Get-ChildItem -Path ".\publish_output\*.*"
          # Get the list of files matching the pattern and pass them as arguments
          $filesToHash = Get-ChildItem -Path ".\publish_output\*64*.*"
          & "$env:build_location\python\python.exe" -c "import sys;from wppm import hash; hash.print_hashes(sys.argv[1:])" @($filesToHash.FullName) | Out-File -FilePath $DESTFILE
          gc $DESTFILE

      # Example artifact upload step (optional)
      - name: Upload artifacts
        if: env.WINPYREQUIREMENTS != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: publish_output
          retention-days: 66  # keeps artifact for 66 days
